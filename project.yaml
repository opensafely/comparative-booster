version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Pre-server scripts 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and tidy 
  ## # # # # # # # # # # # # # # # # # # # 

  extract:
    run: cohortextractor:latest generate_cohort --study-definition study_definition
      --output-format feather
    needs: []
    outputs:
      highly_sensitive:
        cohort: output/input.feather

  data_process:
    run: r:latest analysis/data_process.R
    needs:
    - extract
    outputs:
      highly_sensitive:
        rds: output/data/data_processed.rds
        vaxlong: output/data/data_vaxlong.rds
   

  skim_process:
    run: r:latest analysis/data_skim.R output/data/data_processed.rds output/data_properties
    needs:
    - data_process
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_processed*.txt

  data_selection:
    run: r:latest analysis/data_selection.R
    needs:
    - data_process
    outputs:
      highly_sensitive:
        feather: output/data/data_cohort.feather
        cohortrds: output/data/data_cohort.rds
        criteriards: output/data/data_inclusioncriteria.rds
      moderately_sensitive:
        flow: output/data/flowchart.csv

  skim_selection:
    run: r:latest analysis/data_skim.R output/data/data_cohort.rds output/data_properties
    needs:
    - data_selection
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_cohort*.txt

