version: '3.0'

expectations:

  population_size: 1000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Pre-server scripts 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and tidy 
  ## # # # # # # # # # # # # # # # # # # # 

  extract:
    run: ehrql:v0 generate-dataset analysis/dataset_definition.py --output output/extracts/extract.arrow
      --dummy-data-file analysis/dummydata/dummyextract.arrow
    needs: []
    outputs:
      highly_sensitive:
        cohort: output/extracts/extract.arrow

  data_process:
    run: r:latest analysis/data_process.R
    needs:
    - extract
    outputs:
      highly_sensitive:
        rds: output/data/data_processed.rds
        vaxlong: output/data/data_vaxlong.rds

  skim_process:
    run: r:latest analysis/data_skim.R output/data/data_processed.rds output/data_properties
    needs:
    - data_process
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_processed*.txt

  data_selection:
    run: r:latest analysis/data_selection.R
    needs:
    - data_process
    outputs:
      highly_sensitive:
        rds: output/data/*.rds
      moderately_sensitive:
        csv: output/prematch/*.csv

  skim_selection:
    run: r:latest analysis/data_skim.R output/data/data_cohort.rds output/data_properties
    needs:
    - data_selection
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_cohort*.txt

  geography:
    run: r:latest analysis/geography.R
    needs:
    - data_process
    outputs:
      moderately_sensitive:
        png: output/geography/*.png
        csv: output/geography/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## matching set A 
  ## # # # # # # # # # # # # # # # # # # # 

  match_A:
    run: r:latest analysis/match.R A
    needs:
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/*.rds

  match_report_A:
    run: r:latest analysis/match_report.R A
    needs:
    - data_selection
    - match_A
    outputs:
      moderately_sensitive:
        csv: output/match/A/report/*.csv
        png: output/match/A/report/*.png

  ## ### Overall models (''all'') 

  km_A_all_covidemergency:
    run: r:latest analysis/km.R A all covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/all/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/A/km/all/covidemergency/*.png

  km_A_all_covidadmitted:
    run: r:latest analysis/km.R A all covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/all/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/A/km/all/covidadmitted/*.png

  km_A_all_covidcritcare:
    run: r:latest analysis/km.R A all covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/all/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/A/km/all/covidcritcare/*.png

  km_A_all_coviddeath:
    run: r:latest analysis/km.R A all coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/all/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/all/coviddeath/*.png

  km_A_all_noncoviddeath:
    run: r:latest analysis/km.R A all noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/all/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/all/noncoviddeath/*.png

  km_A_all_fracture:
    run: r:latest analysis/km.R A all fracture
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/all/fracture/*.rds
      moderately_sensitive:
        png: output/match/A/km/all/fracture/*.png

  ## ### Models by age (''age75plus'') 

  km_A_age75plus_covidemergency:
    run: r:latest analysis/km.R A age75plus covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/age75plus/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/A/km/age75plus/covidemergency/*.png

  km_A_age75plus_covidadmitted:
    run: r:latest analysis/km.R A age75plus covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/age75plus/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/A/km/age75plus/covidadmitted/*.png

  km_A_age75plus_covidcritcare:
    run: r:latest analysis/km.R A age75plus covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/age75plus/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/A/km/age75plus/covidcritcare/*.png

  km_A_age75plus_coviddeath:
    run: r:latest analysis/km.R A age75plus coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/age75plus/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/age75plus/coviddeath/*.png

  km_A_age75plus_noncoviddeath:
    run: r:latest analysis/km.R A age75plus noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/age75plus/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/age75plus/noncoviddeath/*.png

  km_A_age75plus_fracture:
    run: r:latest analysis/km.R A age75plus fracture
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/age75plus/fracture/*.rds
      moderately_sensitive:
        png: output/match/A/km/age75plus/fracture/*.png

  ## ### Models by age-band (''ageband'') 

  km_A_ageband_covidemergency:
    run: r:latest analysis/km.R A ageband covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/ageband/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/A/km/ageband/covidemergency/*.png

  km_A_ageband_covidadmitted:
    run: r:latest analysis/km.R A ageband covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/ageband/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/A/km/ageband/covidadmitted/*.png

  km_A_ageband_covidcritcare:
    run: r:latest analysis/km.R A ageband covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/ageband/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/A/km/ageband/covidcritcare/*.png

  km_A_ageband_coviddeath:
    run: r:latest analysis/km.R A ageband coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/ageband/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/ageband/coviddeath/*.png

  km_A_ageband_noncoviddeath:
    run: r:latest analysis/km.R A ageband noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/ageband/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/ageband/noncoviddeath/*.png

  km_A_ageband_fracture:
    run: r:latest analysis/km.R A ageband fracture
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/ageband/fracture/*.rds
      moderately_sensitive:
        png: output/match/A/km/ageband/fracture/*.png

  ## ### Models by clinically vulnerable group (''cv'') 

  km_A_cv_covidemergency:
    run: r:latest analysis/km.R A cv covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/cv/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/A/km/cv/covidemergency/*.png

  km_A_cv_covidadmitted:
    run: r:latest analysis/km.R A cv covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/cv/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/A/km/cv/covidadmitted/*.png

  km_A_cv_covidcritcare:
    run: r:latest analysis/km.R A cv covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/cv/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/A/km/cv/covidcritcare/*.png

  km_A_cv_coviddeath:
    run: r:latest analysis/km.R A cv coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/cv/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/cv/coviddeath/*.png

  km_A_cv_noncoviddeath:
    run: r:latest analysis/km.R A cv noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/cv/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/cv/noncoviddeath/*.png

  km_A_cv_fracture:
    run: r:latest analysis/km.R A cv fracture
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/cv/fracture/*.rds
      moderately_sensitive:
        png: output/match/A/km/cv/fracture/*.png

  ## ### Models by prior infection (''prior_covid_infection'') 

  km_A_prior_covid_infection_covidemergency:
    run: r:latest analysis/km.R A prior_covid_infection covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/prior_covid_infection/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/A/km/prior_covid_infection/covidemergency/*.png

  km_A_prior_covid_infection_covidadmitted:
    run: r:latest analysis/km.R A prior_covid_infection covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/prior_covid_infection/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/A/km/prior_covid_infection/covidadmitted/*.png

  km_A_prior_covid_infection_covidcritcare:
    run: r:latest analysis/km.R A prior_covid_infection covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/prior_covid_infection/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/A/km/prior_covid_infection/covidcritcare/*.png

  km_A_prior_covid_infection_coviddeath:
    run: r:latest analysis/km.R A prior_covid_infection coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/prior_covid_infection/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/prior_covid_infection/coviddeath/*.png

  km_A_prior_covid_infection_noncoviddeath:
    run: r:latest analysis/km.R A prior_covid_infection noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/prior_covid_infection/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/prior_covid_infection/noncoviddeath/*.png

  km_A_prior_covid_infection_fracture:
    run: r:latest analysis/km.R A prior_covid_infection fracture
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/prior_covid_infection/fracture/*.rds
      moderately_sensitive:
        png: output/match/A/km/prior_covid_infection/fracture/*.png

  ## ### Models by vax history (''vax_previous_count'') 

  km_A_vax_previous_count_covidemergency:
    run: r:latest analysis/km.R A vax_previous_count covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/vax_previous_count/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/A/km/vax_previous_count/covidemergency/*.png

  km_A_vax_previous_count_covidadmitted:
    run: r:latest analysis/km.R A vax_previous_count covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/vax_previous_count/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/A/km/vax_previous_count/covidadmitted/*.png

  km_A_vax_previous_count_covidcritcare:
    run: r:latest analysis/km.R A vax_previous_count covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/vax_previous_count/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/A/km/vax_previous_count/covidcritcare/*.png

  km_A_vax_previous_count_coviddeath:
    run: r:latest analysis/km.R A vax_previous_count coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/vax_previous_count/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/vax_previous_count/coviddeath/*.png

  km_A_vax_previous_count_noncoviddeath:
    run: r:latest analysis/km.R A vax_previous_count noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/vax_previous_count/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/A/km/vax_previous_count/noncoviddeath/*.png

  km_A_vax_previous_count_fracture:
    run: r:latest analysis/km.R A vax_previous_count fracture
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/km/vax_previous_count/fracture/*.rds
      moderately_sensitive:
        png: output/match/A/km/vax_previous_count/fracture/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## matching set B 
  ## # # # # # # # # # # # # # # # # # # # 

  match_B:
    run: r:latest analysis/match.R B
    needs:
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/*.rds

  match_report_B:
    run: r:latest analysis/match_report.R B
    needs:
    - data_selection
    - match_B
    outputs:
      moderately_sensitive:
        csv: output/match/B/report/*.csv
        png: output/match/B/report/*.png

  ## ### Overall models (''all'') 

  km_B_all_covidemergency:
    run: r:latest analysis/km.R B all covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/all/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/B/km/all/covidemergency/*.png

  km_B_all_covidadmitted:
    run: r:latest analysis/km.R B all covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/all/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/B/km/all/covidadmitted/*.png

  km_B_all_covidcritcare:
    run: r:latest analysis/km.R B all covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/all/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/B/km/all/covidcritcare/*.png

  km_B_all_coviddeath:
    run: r:latest analysis/km.R B all coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/all/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/all/coviddeath/*.png

  km_B_all_noncoviddeath:
    run: r:latest analysis/km.R B all noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/all/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/all/noncoviddeath/*.png

  km_B_all_fracture:
    run: r:latest analysis/km.R B all fracture
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/all/fracture/*.rds
      moderately_sensitive:
        png: output/match/B/km/all/fracture/*.png

  ## ### Models by age (''age75plus'') 

  km_B_age75plus_covidemergency:
    run: r:latest analysis/km.R B age75plus covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/age75plus/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/B/km/age75plus/covidemergency/*.png

  km_B_age75plus_covidadmitted:
    run: r:latest analysis/km.R B age75plus covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/age75plus/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/B/km/age75plus/covidadmitted/*.png

  km_B_age75plus_covidcritcare:
    run: r:latest analysis/km.R B age75plus covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/age75plus/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/B/km/age75plus/covidcritcare/*.png

  km_B_age75plus_coviddeath:
    run: r:latest analysis/km.R B age75plus coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/age75plus/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/age75plus/coviddeath/*.png

  km_B_age75plus_noncoviddeath:
    run: r:latest analysis/km.R B age75plus noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/age75plus/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/age75plus/noncoviddeath/*.png

  km_B_age75plus_fracture:
    run: r:latest analysis/km.R B age75plus fracture
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/age75plus/fracture/*.rds
      moderately_sensitive:
        png: output/match/B/km/age75plus/fracture/*.png

  ## ### Models by age-band (''ageband'') 

  km_B_ageband_covidemergency:
    run: r:latest analysis/km.R B ageband covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/ageband/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/B/km/ageband/covidemergency/*.png

  km_B_ageband_covidadmitted:
    run: r:latest analysis/km.R B ageband covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/ageband/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/B/km/ageband/covidadmitted/*.png

  km_B_ageband_covidcritcare:
    run: r:latest analysis/km.R B ageband covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/ageband/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/B/km/ageband/covidcritcare/*.png

  km_B_ageband_coviddeath:
    run: r:latest analysis/km.R B ageband coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/ageband/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/ageband/coviddeath/*.png

  km_B_ageband_noncoviddeath:
    run: r:latest analysis/km.R B ageband noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/ageband/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/ageband/noncoviddeath/*.png

  km_B_ageband_fracture:
    run: r:latest analysis/km.R B ageband fracture
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/ageband/fracture/*.rds
      moderately_sensitive:
        png: output/match/B/km/ageband/fracture/*.png

  ## ### Models by clinically vulnerable group (''cv'') 

  km_B_cv_covidemergency:
    run: r:latest analysis/km.R B cv covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/cv/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/B/km/cv/covidemergency/*.png

  km_B_cv_covidadmitted:
    run: r:latest analysis/km.R B cv covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/cv/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/B/km/cv/covidadmitted/*.png

  km_B_cv_covidcritcare:
    run: r:latest analysis/km.R B cv covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/cv/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/B/km/cv/covidcritcare/*.png

  km_B_cv_coviddeath:
    run: r:latest analysis/km.R B cv coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/cv/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/cv/coviddeath/*.png

  km_B_cv_noncoviddeath:
    run: r:latest analysis/km.R B cv noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/cv/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/cv/noncoviddeath/*.png

  km_B_cv_fracture:
    run: r:latest analysis/km.R B cv fracture
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/cv/fracture/*.rds
      moderately_sensitive:
        png: output/match/B/km/cv/fracture/*.png

  ## ### Models by vax history (''vax_previous_count'') 

  km_B_vax_previous_count_covidemergency:
    run: r:latest analysis/km.R B vax_previous_count covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/vax_previous_count/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/B/km/vax_previous_count/covidemergency/*.png

  km_B_vax_previous_count_covidadmitted:
    run: r:latest analysis/km.R B vax_previous_count covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/vax_previous_count/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/B/km/vax_previous_count/covidadmitted/*.png

  km_B_vax_previous_count_covidcritcare:
    run: r:latest analysis/km.R B vax_previous_count covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/vax_previous_count/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/B/km/vax_previous_count/covidcritcare/*.png

  km_B_vax_previous_count_coviddeath:
    run: r:latest analysis/km.R B vax_previous_count coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/vax_previous_count/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/vax_previous_count/coviddeath/*.png

  km_B_vax_previous_count_noncoviddeath:
    run: r:latest analysis/km.R B vax_previous_count noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/vax_previous_count/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/vax_previous_count/noncoviddeath/*.png

  km_B_vax_previous_count_fracture:
    run: r:latest analysis/km.R B vax_previous_count fracture
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/vax_previous_count/fracture/*.rds
      moderately_sensitive:
        png: output/match/B/km/vax_previous_count/fracture/*.png

  ## ### Models by prior infection (''prior_covid_infection'') 

  km_B_prior_covid_infection_covidemergency:
    run: r:latest analysis/km.R B prior_covid_infection covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/prior_covid_infection/covidemergency/*.rds
      moderately_sensitive:
        png: output/match/B/km/prior_covid_infection/covidemergency/*.png

  km_B_prior_covid_infection_covidadmitted:
    run: r:latest analysis/km.R B prior_covid_infection covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/prior_covid_infection/covidadmitted/*.rds
      moderately_sensitive:
        png: output/match/B/km/prior_covid_infection/covidadmitted/*.png

  km_B_prior_covid_infection_covidcritcare:
    run: r:latest analysis/km.R B prior_covid_infection covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/prior_covid_infection/covidcritcare/*.rds
      moderately_sensitive:
        png: output/match/B/km/prior_covid_infection/covidcritcare/*.png

  km_B_prior_covid_infection_coviddeath:
    run: r:latest analysis/km.R B prior_covid_infection coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/prior_covid_infection/coviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/prior_covid_infection/coviddeath/*.png

  km_B_prior_covid_infection_noncoviddeath:
    run: r:latest analysis/km.R B prior_covid_infection noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/prior_covid_infection/noncoviddeath/*.rds
      moderately_sensitive:
        png: output/match/B/km/prior_covid_infection/noncoviddeath/*.png

  km_B_prior_covid_infection_fracture:
    run: r:latest analysis/km.R B prior_covid_infection fracture
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/km/prior_covid_infection/fracture/*.rds
      moderately_sensitive:
        png: output/match/B/km/prior_covid_infection/fracture/*.png

  eventcounts_A:
    run: r:latest analysis/eventcounts.R A
    needs:
    - match_A
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/eventcounts/*.rds

  eventcounts_B:
    run: r:latest analysis/eventcounts.R B
    needs:
    - match_B
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/eventcounts/*.rds

  ## # # # # # # # # # # # # # # # # # # # 
  ## Combine estimates across outcomes and subgroups 
  ## # # # # # # # # # # # # # # # # # # # 

  contrasts_combine_A:
    run: r:latest analysis/contrasts_combine.R A
    needs:
    - km_A_all_covidemergency
    - km_A_all_covidadmitted
    - km_A_all_covidcritcare
    - km_A_all_coviddeath
    - km_A_all_noncoviddeath
    - km_A_all_fracture
    - km_A_age75plus_covidemergency
    - km_A_age75plus_covidadmitted
    - km_A_age75plus_covidcritcare
    - km_A_age75plus_coviddeath
    - km_A_age75plus_noncoviddeath
    - km_A_age75plus_fracture
    - km_A_ageband_covidemergency
    - km_A_ageband_covidadmitted
    - km_A_ageband_covidcritcare
    - km_A_ageband_coviddeath
    - km_A_ageband_noncoviddeath
    - km_A_ageband_fracture
    - km_A_cv_covidemergency
    - km_A_cv_covidadmitted
    - km_A_cv_covidcritcare
    - km_A_cv_coviddeath
    - km_A_cv_noncoviddeath
    - km_A_cv_fracture
    - km_A_vax_previous_count_covidemergency
    - km_A_vax_previous_count_covidadmitted
    - km_A_vax_previous_count_covidcritcare
    - km_A_vax_previous_count_coviddeath
    - km_A_vax_previous_count_noncoviddeath
    - km_A_vax_previous_count_fracture
    - km_A_prior_covid_infection_covidemergency
    - km_A_prior_covid_infection_covidadmitted
    - km_A_prior_covid_infection_covidcritcare
    - km_A_prior_covid_infection_coviddeath
    - km_A_prior_covid_infection_noncoviddeath
    - km_A_prior_covid_infection_fracture
    - eventcounts_A
    outputs:
      moderately_sensitive:
        csv: output/match/A/combined/*.csv
        png: output/match/A/combined/plots/*.png

  contrasts_combine_B:
    run: r:latest analysis/contrasts_combine.R B
    needs:
    - km_B_all_covidemergency
    - km_B_all_covidadmitted
    - km_B_all_covidcritcare
    - km_B_all_coviddeath
    - km_B_all_noncoviddeath
    - km_B_all_fracture
    - km_B_age75plus_covidemergency
    - km_B_age75plus_covidadmitted
    - km_B_age75plus_covidcritcare
    - km_B_age75plus_coviddeath
    - km_B_age75plus_noncoviddeath
    - km_B_age75plus_fracture
    - km_B_ageband_covidemergency
    - km_B_ageband_covidadmitted
    - km_B_ageband_covidcritcare
    - km_B_ageband_coviddeath
    - km_B_ageband_noncoviddeath
    - km_B_ageband_fracture
    - km_B_cv_covidemergency
    - km_B_cv_covidadmitted
    - km_B_cv_covidcritcare
    - km_B_cv_coviddeath
    - km_B_cv_noncoviddeath
    - km_B_cv_fracture
    - km_B_vax_previous_count_covidemergency
    - km_B_vax_previous_count_covidadmitted
    - km_B_vax_previous_count_covidcritcare
    - km_B_vax_previous_count_coviddeath
    - km_B_vax_previous_count_noncoviddeath
    - km_B_vax_previous_count_fracture
    - km_B_prior_covid_infection_covidemergency
    - km_B_prior_covid_infection_covidadmitted
    - km_B_prior_covid_infection_covidcritcare
    - km_B_prior_covid_infection_coviddeath
    - km_B_prior_covid_infection_noncoviddeath
    - km_B_prior_covid_infection_fracture
    - eventcounts_B
    outputs:
      moderately_sensitive:
        csv: output/match/B/combined/*.csv
        png: output/match/B/combined/plots/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## Files for release 
  ## # # # # # # # # # # # # # # # # # # # 

  release_objects:
    run: r:latest analysis/release_objects.R
    needs:
    - data_selection
    - match_report_A
    - match_report_B
    - contrasts_combine_A
    - contrasts_combine_B
    outputs:
      moderately_sensitive:
        releaselist: output/files-for-release.txt
        command: output/osrelease-command.txt
        csv: output/release-objects/*/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## End 
  ## # # # # # # # # # # # # # # # # # # # 

