version: '3.0'

expectations:

  population_size: 1000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Pre-server scripts 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and tidy 
  ## # # # # # # # # # # # # # # # # # # # 

  extract:
    run: cohortextractor:latest generate_cohort --study-definition study_definition
      --output-format feather
    needs: []
    outputs:
      highly_sensitive:
        cohort: output/input.feather

  data_process:
    run: r:latest analysis/data_process.R
    needs:
    - extract
    outputs:
      highly_sensitive:
        rds: output/data/data_processed.rds
        vaxlong: output/data/data_vaxlong.rds

  skim_process:
    run: r:latest analysis/data_skim.R output/data/data_processed.rds output/data_properties
    needs:
    - data_process
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_processed*.txt

  data_selection:
    run: r:latest analysis/data_selection.R
    needs:
    - data_process
    outputs:
      highly_sensitive:
        feather: output/data/*.feather
        rds: output/data/*.rds
      moderately_sensitive:
        csv: output/prematch/*.csv

  skim_selection:
    run: r:latest analysis/data_skim.R output/data/data_cohort.rds output/data_properties
    needs:
    - data_selection
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_cohort*.txt

  geography:
    run: r:latest analysis/geography.R
    needs:
    - data_process
    outputs:
      moderately_sensitive:
        png: output/geography/*.png
        csv: output/geography/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## matching set A 
  ## # # # # # # # # # # # # # # # # # # # 

  match_A:
    run: r:latest analysis/match.R A
    needs:
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/A/*.rds

  match_report_A:
    run: r:latest analysis/match_report.R A
    needs:
    - data_selection
    - match_A
    outputs:
      moderately_sensitive:
        csv: output/match/A/report/*.csv
        png: output/match/A/report/*.png

  ## ### Overall models (''all'') 

  km_A_all_postest:
    run: r:latest analysis/km.R A all postest
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/all/postest/*.rds
        png: output/match/A/km/all/postest/*.png

  km_A_all_covidemergency:
    run: r:latest analysis/km.R A all covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/all/covidemergency/*.rds
        png: output/match/A/km/all/covidemergency/*.png

  km_A_all_covidadmittedproxy1:
    run: r:latest analysis/km.R A all covidadmittedproxy1
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/all/covidadmittedproxy1/*.rds
        png: output/match/A/km/all/covidadmittedproxy1/*.png

  km_A_all_covidadmitted:
    run: r:latest analysis/km.R A all covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/all/covidadmitted/*.rds
        png: output/match/A/km/all/covidadmitted/*.png

  km_A_all_covidcritcare:
    run: r:latest analysis/km.R A all covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/all/covidcritcare/*.rds
        png: output/match/A/km/all/covidcritcare/*.png

  km_A_all_coviddeath:
    run: r:latest analysis/km.R A all coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/all/coviddeath/*.rds
        png: output/match/A/km/all/coviddeath/*.png

  km_A_all_noncoviddeath:
    run: r:latest analysis/km.R A all noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/all/noncoviddeath/*.rds
        png: output/match/A/km/all/noncoviddeath/*.png

  delayedentry_A_all_postest:
    run: r:latest analysis/delayedentry.R A all postest
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/delayedentry/all/postest/*.rds
        png: output/match/A/delayedentry/all/postest/*.png

  delayedentry_A_all_covidemergency:
    run: r:latest analysis/delayedentry.R A all covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/delayedentry/all/covidemergency/*.rds
        png: output/match/A/delayedentry/all/covidemergency/*.png

  delayedentry_A_all_covidadmittedproxy1:
    run: r:latest analysis/delayedentry.R A all covidadmittedproxy1
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/delayedentry/all/covidadmittedproxy1/*.rds
        png: output/match/A/delayedentry/all/covidadmittedproxy1/*.png

  delayedentry_A_all_covidadmitted:
    run: r:latest analysis/delayedentry.R A all covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/delayedentry/all/covidadmitted/*.rds
        png: output/match/A/delayedentry/all/covidadmitted/*.png

  delayedentry_A_all_covidcritcare:
    run: r:latest analysis/delayedentry.R A all covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/delayedentry/all/covidcritcare/*.rds
        png: output/match/A/delayedentry/all/covidcritcare/*.png

  delayedentry_A_all_coviddeath:
    run: r:latest analysis/delayedentry.R A all coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/delayedentry/all/coviddeath/*.rds
        png: output/match/A/delayedentry/all/coviddeath/*.png

  delayedentry_A_all_noncoviddeath:
    run: r:latest analysis/delayedentry.R A all noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/delayedentry/all/noncoviddeath/*.rds
        png: output/match/A/delayedentry/all/noncoviddeath/*.png

  ## ### Models by primary course (''vax12_type'') 

  km_A_vax12_type_postest:
    run: r:latest analysis/km.R A vax12_type postest
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/vax12_type/postest/*.rds
        png: output/match/A/km/vax12_type/postest/*.png

  km_A_vax12_type_covidemergency:
    run: r:latest analysis/km.R A vax12_type covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/vax12_type/covidemergency/*.rds
        png: output/match/A/km/vax12_type/covidemergency/*.png

  km_A_vax12_type_covidadmittedproxy1:
    run: r:latest analysis/km.R A vax12_type covidadmittedproxy1
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/vax12_type/covidadmittedproxy1/*.rds
        png: output/match/A/km/vax12_type/covidadmittedproxy1/*.png

  km_A_vax12_type_covidadmitted:
    run: r:latest analysis/km.R A vax12_type covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/vax12_type/covidadmitted/*.rds
        png: output/match/A/km/vax12_type/covidadmitted/*.png

  km_A_vax12_type_covidcritcare:
    run: r:latest analysis/km.R A vax12_type covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/vax12_type/covidcritcare/*.rds
        png: output/match/A/km/vax12_type/covidcritcare/*.png

  km_A_vax12_type_coviddeath:
    run: r:latest analysis/km.R A vax12_type coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/vax12_type/coviddeath/*.rds
        png: output/match/A/km/vax12_type/coviddeath/*.png

  km_A_vax12_type_noncoviddeath:
    run: r:latest analysis/km.R A vax12_type noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/vax12_type/noncoviddeath/*.rds
        png: output/match/A/km/vax12_type/noncoviddeath/*.png

  ## ### Models by clinically vulnerable group (''cev_cv'') 

  km_A_cev_cv_postest:
    run: r:latest analysis/km.R A cev_cv postest
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/cev_cv/postest/*.rds
        png: output/match/A/km/cev_cv/postest/*.png

  km_A_cev_cv_covidemergency:
    run: r:latest analysis/km.R A cev_cv covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/cev_cv/covidemergency/*.rds
        png: output/match/A/km/cev_cv/covidemergency/*.png

  km_A_cev_cv_covidadmittedproxy1:
    run: r:latest analysis/km.R A cev_cv covidadmittedproxy1
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/cev_cv/covidadmittedproxy1/*.rds
        png: output/match/A/km/cev_cv/covidadmittedproxy1/*.png

  km_A_cev_cv_covidadmitted:
    run: r:latest analysis/km.R A cev_cv covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/cev_cv/covidadmitted/*.rds
        png: output/match/A/km/cev_cv/covidadmitted/*.png

  km_A_cev_cv_covidcritcare:
    run: r:latest analysis/km.R A cev_cv covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/cev_cv/covidcritcare/*.rds
        png: output/match/A/km/cev_cv/covidcritcare/*.png

  km_A_cev_cv_coviddeath:
    run: r:latest analysis/km.R A cev_cv coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/cev_cv/coviddeath/*.rds
        png: output/match/A/km/cev_cv/coviddeath/*.png

  km_A_cev_cv_noncoviddeath:
    run: r:latest analysis/km.R A cev_cv noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/cev_cv/noncoviddeath/*.rds
        png: output/match/A/km/cev_cv/noncoviddeath/*.png

  ## ### Models by prior infection (''prior_covid_infection'') 

  km_A_prior_covid_infection_postest:
    run: r:latest analysis/km.R A prior_covid_infection postest
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/prior_covid_infection/postest/*.rds
        png: output/match/A/km/prior_covid_infection/postest/*.png

  km_A_prior_covid_infection_covidemergency:
    run: r:latest analysis/km.R A prior_covid_infection covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/prior_covid_infection/covidemergency/*.rds
        png: output/match/A/km/prior_covid_infection/covidemergency/*.png

  km_A_prior_covid_infection_covidadmittedproxy1:
    run: r:latest analysis/km.R A prior_covid_infection covidadmittedproxy1
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/prior_covid_infection/covidadmittedproxy1/*.rds
        png: output/match/A/km/prior_covid_infection/covidadmittedproxy1/*.png

  km_A_prior_covid_infection_covidadmitted:
    run: r:latest analysis/km.R A prior_covid_infection covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/prior_covid_infection/covidadmitted/*.rds
        png: output/match/A/km/prior_covid_infection/covidadmitted/*.png

  km_A_prior_covid_infection_covidcritcare:
    run: r:latest analysis/km.R A prior_covid_infection covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/prior_covid_infection/covidcritcare/*.rds
        png: output/match/A/km/prior_covid_infection/covidcritcare/*.png

  km_A_prior_covid_infection_coviddeath:
    run: r:latest analysis/km.R A prior_covid_infection coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/prior_covid_infection/coviddeath/*.rds
        png: output/match/A/km/prior_covid_infection/coviddeath/*.png

  km_A_prior_covid_infection_noncoviddeath:
    run: r:latest analysis/km.R A prior_covid_infection noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/prior_covid_infection/noncoviddeath/*.rds
        png: output/match/A/km/prior_covid_infection/noncoviddeath/*.png

  ## ### Models by age (''age65plus'') 

  km_A_age65plus_postest:
    run: r:latest analysis/km.R A age65plus postest
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/age65plus/postest/*.rds
        png: output/match/A/km/age65plus/postest/*.png

  km_A_age65plus_covidemergency:
    run: r:latest analysis/km.R A age65plus covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/age65plus/covidemergency/*.rds
        png: output/match/A/km/age65plus/covidemergency/*.png

  km_A_age65plus_covidadmittedproxy1:
    run: r:latest analysis/km.R A age65plus covidadmittedproxy1
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/age65plus/covidadmittedproxy1/*.rds
        png: output/match/A/km/age65plus/covidadmittedproxy1/*.png

  km_A_age65plus_covidadmitted:
    run: r:latest analysis/km.R A age65plus covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/age65plus/covidadmitted/*.rds
        png: output/match/A/km/age65plus/covidadmitted/*.png

  km_A_age65plus_covidcritcare:
    run: r:latest analysis/km.R A age65plus covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/age65plus/covidcritcare/*.rds
        png: output/match/A/km/age65plus/covidcritcare/*.png

  km_A_age65plus_coviddeath:
    run: r:latest analysis/km.R A age65plus coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/age65plus/coviddeath/*.rds
        png: output/match/A/km/age65plus/coviddeath/*.png

  km_A_age65plus_noncoviddeath:
    run: r:latest analysis/km.R A age65plus noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/age65plus/noncoviddeath/*.rds
        png: output/match/A/km/age65plus/noncoviddeath/*.png

  ## ### Models by variant era (''variantera'') 

  km_A_variantera_postest:
    run: r:latest analysis/km.R A variantera postest
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/variantera/postest/*.rds
        png: output/match/A/km/variantera/postest/*.png

  km_A_variantera_covidemergency:
    run: r:latest analysis/km.R A variantera covidemergency
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/variantera/covidemergency/*.rds
        png: output/match/A/km/variantera/covidemergency/*.png

  km_A_variantera_covidadmittedproxy1:
    run: r:latest analysis/km.R A variantera covidadmittedproxy1
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/variantera/covidadmittedproxy1/*.rds
        png: output/match/A/km/variantera/covidadmittedproxy1/*.png

  km_A_variantera_covidadmitted:
    run: r:latest analysis/km.R A variantera covidadmitted
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/variantera/covidadmitted/*.rds
        png: output/match/A/km/variantera/covidadmitted/*.png

  km_A_variantera_covidcritcare:
    run: r:latest analysis/km.R A variantera covidcritcare
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/variantera/covidcritcare/*.rds
        png: output/match/A/km/variantera/covidcritcare/*.png

  km_A_variantera_coviddeath:
    run: r:latest analysis/km.R A variantera coviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/variantera/coviddeath/*.rds
        png: output/match/A/km/variantera/coviddeath/*.png

  km_A_variantera_noncoviddeath:
    run: r:latest analysis/km.R A variantera noncoviddeath
    needs:
    - match_A
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/A/km/variantera/noncoviddeath/*.rds
        png: output/match/A/km/variantera/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## matching set B 
  ## # # # # # # # # # # # # # # # # # # # 

  match_B:
    run: r:latest analysis/match.R B
    needs:
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/match/B/*.rds

  match_report_B:
    run: r:latest analysis/match_report.R B
    needs:
    - data_selection
    - match_B
    outputs:
      moderately_sensitive:
        csv: output/match/B/report/*.csv
        png: output/match/B/report/*.png

  ## ### Overall models (''all'') 

  km_B_all_postest:
    run: r:latest analysis/km.R B all postest
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/all/postest/*.rds
        png: output/match/B/km/all/postest/*.png

  km_B_all_covidemergency:
    run: r:latest analysis/km.R B all covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/all/covidemergency/*.rds
        png: output/match/B/km/all/covidemergency/*.png

  km_B_all_covidadmittedproxy1:
    run: r:latest analysis/km.R B all covidadmittedproxy1
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/all/covidadmittedproxy1/*.rds
        png: output/match/B/km/all/covidadmittedproxy1/*.png

  km_B_all_covidadmitted:
    run: r:latest analysis/km.R B all covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/all/covidadmitted/*.rds
        png: output/match/B/km/all/covidadmitted/*.png

  km_B_all_covidcritcare:
    run: r:latest analysis/km.R B all covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/all/covidcritcare/*.rds
        png: output/match/B/km/all/covidcritcare/*.png

  km_B_all_coviddeath:
    run: r:latest analysis/km.R B all coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/all/coviddeath/*.rds
        png: output/match/B/km/all/coviddeath/*.png

  km_B_all_noncoviddeath:
    run: r:latest analysis/km.R B all noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/all/noncoviddeath/*.rds
        png: output/match/B/km/all/noncoviddeath/*.png

  delayedentry_B_all_postest:
    run: r:latest analysis/delayedentry.R B all postest
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/delayedentry/all/postest/*.rds
        png: output/match/B/delayedentry/all/postest/*.png

  delayedentry_B_all_covidemergency:
    run: r:latest analysis/delayedentry.R B all covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/delayedentry/all/covidemergency/*.rds
        png: output/match/B/delayedentry/all/covidemergency/*.png

  delayedentry_B_all_covidadmittedproxy1:
    run: r:latest analysis/delayedentry.R B all covidadmittedproxy1
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/delayedentry/all/covidadmittedproxy1/*.rds
        png: output/match/B/delayedentry/all/covidadmittedproxy1/*.png

  delayedentry_B_all_covidadmitted:
    run: r:latest analysis/delayedentry.R B all covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/delayedentry/all/covidadmitted/*.rds
        png: output/match/B/delayedentry/all/covidadmitted/*.png

  delayedentry_B_all_covidcritcare:
    run: r:latest analysis/delayedentry.R B all covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/delayedentry/all/covidcritcare/*.rds
        png: output/match/B/delayedentry/all/covidcritcare/*.png

  delayedentry_B_all_coviddeath:
    run: r:latest analysis/delayedentry.R B all coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/delayedentry/all/coviddeath/*.rds
        png: output/match/B/delayedentry/all/coviddeath/*.png

  delayedentry_B_all_noncoviddeath:
    run: r:latest analysis/delayedentry.R B all noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/delayedentry/all/noncoviddeath/*.rds
        png: output/match/B/delayedentry/all/noncoviddeath/*.png

  ## ### Models by primary course (''vax12_type'') 

  km_B_vax12_type_postest:
    run: r:latest analysis/km.R B vax12_type postest
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/vax12_type/postest/*.rds
        png: output/match/B/km/vax12_type/postest/*.png

  km_B_vax12_type_covidemergency:
    run: r:latest analysis/km.R B vax12_type covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/vax12_type/covidemergency/*.rds
        png: output/match/B/km/vax12_type/covidemergency/*.png

  km_B_vax12_type_covidadmittedproxy1:
    run: r:latest analysis/km.R B vax12_type covidadmittedproxy1
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/vax12_type/covidadmittedproxy1/*.rds
        png: output/match/B/km/vax12_type/covidadmittedproxy1/*.png

  km_B_vax12_type_covidadmitted:
    run: r:latest analysis/km.R B vax12_type covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/vax12_type/covidadmitted/*.rds
        png: output/match/B/km/vax12_type/covidadmitted/*.png

  km_B_vax12_type_covidcritcare:
    run: r:latest analysis/km.R B vax12_type covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/vax12_type/covidcritcare/*.rds
        png: output/match/B/km/vax12_type/covidcritcare/*.png

  km_B_vax12_type_coviddeath:
    run: r:latest analysis/km.R B vax12_type coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/vax12_type/coviddeath/*.rds
        png: output/match/B/km/vax12_type/coviddeath/*.png

  km_B_vax12_type_noncoviddeath:
    run: r:latest analysis/km.R B vax12_type noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/vax12_type/noncoviddeath/*.rds
        png: output/match/B/km/vax12_type/noncoviddeath/*.png

  ## ### Models by clinically vulnerable group (''cev_cv'') 

  km_B_cev_cv_postest:
    run: r:latest analysis/km.R B cev_cv postest
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/cev_cv/postest/*.rds
        png: output/match/B/km/cev_cv/postest/*.png

  km_B_cev_cv_covidemergency:
    run: r:latest analysis/km.R B cev_cv covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/cev_cv/covidemergency/*.rds
        png: output/match/B/km/cev_cv/covidemergency/*.png

  km_B_cev_cv_covidadmittedproxy1:
    run: r:latest analysis/km.R B cev_cv covidadmittedproxy1
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/cev_cv/covidadmittedproxy1/*.rds
        png: output/match/B/km/cev_cv/covidadmittedproxy1/*.png

  km_B_cev_cv_covidadmitted:
    run: r:latest analysis/km.R B cev_cv covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/cev_cv/covidadmitted/*.rds
        png: output/match/B/km/cev_cv/covidadmitted/*.png

  km_B_cev_cv_covidcritcare:
    run: r:latest analysis/km.R B cev_cv covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/cev_cv/covidcritcare/*.rds
        png: output/match/B/km/cev_cv/covidcritcare/*.png

  km_B_cev_cv_coviddeath:
    run: r:latest analysis/km.R B cev_cv coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/cev_cv/coviddeath/*.rds
        png: output/match/B/km/cev_cv/coviddeath/*.png

  km_B_cev_cv_noncoviddeath:
    run: r:latest analysis/km.R B cev_cv noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/cev_cv/noncoviddeath/*.rds
        png: output/match/B/km/cev_cv/noncoviddeath/*.png

  ## ### Models by prior infection (''prior_covid_infection'') 

  km_B_prior_covid_infection_postest:
    run: r:latest analysis/km.R B prior_covid_infection postest
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/prior_covid_infection/postest/*.rds
        png: output/match/B/km/prior_covid_infection/postest/*.png

  km_B_prior_covid_infection_covidemergency:
    run: r:latest analysis/km.R B prior_covid_infection covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/prior_covid_infection/covidemergency/*.rds
        png: output/match/B/km/prior_covid_infection/covidemergency/*.png

  km_B_prior_covid_infection_covidadmittedproxy1:
    run: r:latest analysis/km.R B prior_covid_infection covidadmittedproxy1
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/prior_covid_infection/covidadmittedproxy1/*.rds
        png: output/match/B/km/prior_covid_infection/covidadmittedproxy1/*.png

  km_B_prior_covid_infection_covidadmitted:
    run: r:latest analysis/km.R B prior_covid_infection covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/prior_covid_infection/covidadmitted/*.rds
        png: output/match/B/km/prior_covid_infection/covidadmitted/*.png

  km_B_prior_covid_infection_covidcritcare:
    run: r:latest analysis/km.R B prior_covid_infection covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/prior_covid_infection/covidcritcare/*.rds
        png: output/match/B/km/prior_covid_infection/covidcritcare/*.png

  km_B_prior_covid_infection_coviddeath:
    run: r:latest analysis/km.R B prior_covid_infection coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/prior_covid_infection/coviddeath/*.rds
        png: output/match/B/km/prior_covid_infection/coviddeath/*.png

  km_B_prior_covid_infection_noncoviddeath:
    run: r:latest analysis/km.R B prior_covid_infection noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/prior_covid_infection/noncoviddeath/*.rds
        png: output/match/B/km/prior_covid_infection/noncoviddeath/*.png

  ## ### Models by age (''age65plus'') 

  km_B_age65plus_postest:
    run: r:latest analysis/km.R B age65plus postest
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/age65plus/postest/*.rds
        png: output/match/B/km/age65plus/postest/*.png

  km_B_age65plus_covidemergency:
    run: r:latest analysis/km.R B age65plus covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/age65plus/covidemergency/*.rds
        png: output/match/B/km/age65plus/covidemergency/*.png

  km_B_age65plus_covidadmittedproxy1:
    run: r:latest analysis/km.R B age65plus covidadmittedproxy1
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/age65plus/covidadmittedproxy1/*.rds
        png: output/match/B/km/age65plus/covidadmittedproxy1/*.png

  km_B_age65plus_covidadmitted:
    run: r:latest analysis/km.R B age65plus covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/age65plus/covidadmitted/*.rds
        png: output/match/B/km/age65plus/covidadmitted/*.png

  km_B_age65plus_covidcritcare:
    run: r:latest analysis/km.R B age65plus covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/age65plus/covidcritcare/*.rds
        png: output/match/B/km/age65plus/covidcritcare/*.png

  km_B_age65plus_coviddeath:
    run: r:latest analysis/km.R B age65plus coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/age65plus/coviddeath/*.rds
        png: output/match/B/km/age65plus/coviddeath/*.png

  km_B_age65plus_noncoviddeath:
    run: r:latest analysis/km.R B age65plus noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/age65plus/noncoviddeath/*.rds
        png: output/match/B/km/age65plus/noncoviddeath/*.png

  ## ### Models by variant era (''variantera'') 

  km_B_variantera_postest:
    run: r:latest analysis/km.R B variantera postest
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/variantera/postest/*.rds
        png: output/match/B/km/variantera/postest/*.png

  km_B_variantera_covidemergency:
    run: r:latest analysis/km.R B variantera covidemergency
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/variantera/covidemergency/*.rds
        png: output/match/B/km/variantera/covidemergency/*.png

  km_B_variantera_covidadmittedproxy1:
    run: r:latest analysis/km.R B variantera covidadmittedproxy1
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/variantera/covidadmittedproxy1/*.rds
        png: output/match/B/km/variantera/covidadmittedproxy1/*.png

  km_B_variantera_covidadmitted:
    run: r:latest analysis/km.R B variantera covidadmitted
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/variantera/covidadmitted/*.rds
        png: output/match/B/km/variantera/covidadmitted/*.png

  km_B_variantera_covidcritcare:
    run: r:latest analysis/km.R B variantera covidcritcare
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/variantera/covidcritcare/*.rds
        png: output/match/B/km/variantera/covidcritcare/*.png

  km_B_variantera_coviddeath:
    run: r:latest analysis/km.R B variantera coviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/variantera/coviddeath/*.rds
        png: output/match/B/km/variantera/coviddeath/*.png

  km_B_variantera_noncoviddeath:
    run: r:latest analysis/km.R B variantera noncoviddeath
    needs:
    - match_B
    - data_selection
    outputs:
      moderately_sensitive:
        rds: output/match/B/km/variantera/noncoviddeath/*.rds
        png: output/match/B/km/variantera/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## Combine KM / CI estimates across outcomes and subgroups 
  ## # # # # # # # # # # # # # # # # # # # 

  contrasts_combine_A:
    run: r:latest analysis/contrasts_combine.R A
    needs:
    - km_A_all_postest
    - km_A_all_covidemergency
    - km_A_all_covidadmittedproxy1
    - km_A_all_covidadmitted
    - km_A_all_covidcritcare
    - km_A_all_coviddeath
    - km_A_all_noncoviddeath
    - km_A_vax12_type_postest
    - km_A_vax12_type_covidemergency
    - km_A_vax12_type_covidadmittedproxy1
    - km_A_vax12_type_covidadmitted
    - km_A_vax12_type_covidcritcare
    - km_A_vax12_type_coviddeath
    - km_A_vax12_type_noncoviddeath
    - km_A_prior_covid_infection_postest
    - km_A_prior_covid_infection_covidemergency
    - km_A_prior_covid_infection_covidadmittedproxy1
    - km_A_prior_covid_infection_covidadmitted
    - km_A_prior_covid_infection_covidcritcare
    - km_A_prior_covid_infection_coviddeath
    - km_A_prior_covid_infection_noncoviddeath
    - km_A_age65plus_postest
    - km_A_age65plus_covidemergency
    - km_A_age65plus_covidadmittedproxy1
    - km_A_age65plus_covidadmitted
    - km_A_age65plus_covidcritcare
    - km_A_age65plus_coviddeath
    - km_A_age65plus_noncoviddeath
    - km_A_cev_cv_postest
    - km_A_cev_cv_covidemergency
    - km_A_cev_cv_covidadmittedproxy1
    - km_A_cev_cv_covidadmitted
    - km_A_cev_cv_covidcritcare
    - km_A_cev_cv_coviddeath
    - km_A_cev_cv_noncoviddeath
    outputs:
      moderately_sensitive:
        csv: output/match/A/combined/*.csv
        png: output/match/A/combined/plots/*.png

  contrasts_combine_B:
    run: r:latest analysis/contrasts_combine.R B
    needs:
    - km_B_all_postest
    - km_B_all_covidemergency
    - km_B_all_covidadmittedproxy1
    - km_B_all_covidadmitted
    - km_B_all_covidcritcare
    - km_B_all_coviddeath
    - km_B_all_noncoviddeath
    - km_B_vax12_type_postest
    - km_B_vax12_type_covidemergency
    - km_B_vax12_type_covidadmittedproxy1
    - km_B_vax12_type_covidadmitted
    - km_B_vax12_type_covidcritcare
    - km_B_vax12_type_coviddeath
    - km_B_vax12_type_noncoviddeath
    - km_B_prior_covid_infection_postest
    - km_B_prior_covid_infection_covidemergency
    - km_B_prior_covid_infection_covidadmittedproxy1
    - km_B_prior_covid_infection_covidadmitted
    - km_B_prior_covid_infection_covidcritcare
    - km_B_prior_covid_infection_coviddeath
    - km_B_prior_covid_infection_noncoviddeath
    - km_B_age65plus_postest
    - km_B_age65plus_covidemergency
    - km_B_age65plus_covidadmittedproxy1
    - km_B_age65plus_covidadmitted
    - km_B_age65plus_covidcritcare
    - km_B_age65plus_coviddeath
    - km_B_age65plus_noncoviddeath
    - km_B_cev_cv_postest
    - km_B_cev_cv_covidemergency
    - km_B_cev_cv_covidadmittedproxy1
    - km_B_cev_cv_covidadmitted
    - km_B_cev_cv_covidcritcare
    - km_B_cev_cv_coviddeath
    - km_B_cev_cv_noncoviddeath
    outputs:
      moderately_sensitive:
        csv: output/match/B/combined/*.csv
        png: output/match/B/combined/plots/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## Files for release 
  ## # # # # # # # # # # # # # # # # # # # 

  release_objects:
    run: r:latest analysis/release_objects.R
    needs:
    - data_selection
    - match_report_A
    - match_report_B
    - contrasts_combine_A
    - contrasts_combine_B
    outputs:
      moderately_sensitive:
        releaselist: output/files-for-release.txt
        command: output/osrelease-command.txt
        csv: output/release-objects/*/*.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## ICD10 check 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_ICD10check:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_ICD10check
      --output-format feather
    needs: []
    outputs:
      highly_sensitive:
        cohort: output/input_ICD10check.feather

  report_ICD10check:
    run: r:latest analysis/report_ICD10check.R
    needs:
    - extract_ICD10check
    outputs:
      moderately_sensitive:
        png: output/ICD10check/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## End 
  ## # # # # # # # # # # # # # # # # # # # 

